Coloris({alpha:!1});const qrTextInput=document.getElementById("qr-text"),shortenUrlCheckbox=document.getElementById("shorten-url-checkbox"),shortenUrlLabel=document.getElementById("shorten-url-label"),originalShortenLabelText=shortenUrlLabel.textContent,downloadBtn=document.getElementById("download-btn"),downloadBtnPng=document.getElementById("download-btn-png"),copyCodeBtn=document.getElementById("copy-code-btn"),previewEl=document.getElementById("qr-preview"),logoSettings=document.getElementById("logo-settings"),logoUploadInput=document.getElementById("logo-upload-input"),logoUploadLabel=document.getElementById("logo-upload-label"),logoPreview=document.getElementById("logo-preview"),removeLogoWrapper=document.getElementById("remove-logo-wrapper"),dotScaleSlider=document.getElementById("dot-scale-slider"),dotScaleValueSpan=document.getElementById("dot-scale-value"),roundingSlider=document.getElementById("rounding-slider"),roundingValueSpan=document.getElementById("rounding-value"),eyeRoundingSlider=document.getElementById("eye-rounding-slider"),eyeRoundingValueSpan=document.getElementById("eye-rounding-value"),logoRoundingSlider=document.getElementById("logo-rounding-slider"),logoRoundingValueSpan=document.getElementById("logo-rounding-value"),logoSizeSlider=document.getElementById("logo-size-slider"),logoSizeValueSpan=document.getElementById("logo-size-value"),internalRoundingSlider=document.getElementById("internal-rounding-slider"),internalRoundingValueSpan=document.getElementById("internal-rounding-value"),logoRoundingControl=document.getElementById("logo-rounding-control"),logoSizeControl=document.getElementById("logo-size-control"),dotColorControl=document.getElementById("dot-color-control"),eyeColorControl=document.getElementById("eye-color-control"),dotColorPicker=document.getElementById("dot-color-picker"),eyeColorPicker=document.getElementById("eye-color-picker"),gradientDetails=document.getElementById("gradient-details"),gradientColorPicker1=document.getElementById("gradient-color-picker-1"),gradientColorPicker2=document.getElementById("gradient-color-picker-2"),gradientRotationSlider=document.getElementById("gradient-rotation-slider"),gradientRotationValue=document.getElementById("gradient-rotation-value"),gradientToggleCheckbox=document.getElementById("gradient-toggle-checkbox"),gradientSummary=gradientDetails.querySelector("summary"),backgroundSettings=document.getElementById("background-settings"),bgSolidColorControl=document.getElementById("bg-solid-color-control"),bgSolidColorPicker=document.getElementById("bg-solid-color-picker"),bgOpacityControl=document.getElementById("bg-opacity-control"),bgOpacitySlider=document.getElementById("bg-opacity-slider"),bgOpacityValue=document.getElementById("bg-opacity-value"),bgGradientDetails=document.getElementById("bg-gradient-details"),bgGradientCheckbox=document.getElementById("bg-gradient-checkbox"),bgGradientSummary=bgGradientDetails.querySelector("summary"),bgGradientControls=document.getElementById("bg-gradient-controls"),bgGradientColor1=document.getElementById("bg-gradient-color-1"),bgGradientColor2=document.getElementById("bg-gradient-color-2"),bgGradientRotationSlider=document.getElementById("bg-gradient-rotation-slider"),bgGradientRotationValue=document.getElementById("bg-gradient-rotation-value"),bgImageDetails=document.getElementById("bg-image-details"),bgImageCheckbox=document.getElementById("bg-image-checkbox"),bgImageSummary=bgImageDetails.querySelector("summary"),bgImageControls=document.getElementById("bg-image-controls"),backgroundUploadInput=document.getElementById("background-upload-input"),frameTextInput=document.getElementById("frame-text-input"),frameTextControl=document.getElementById("frame-text-control"),frameBgColorControl=document.getElementById("frame-bg-color-control"),frameBgColorPicker=document.getElementById("frame-bg-color-picker"),frameTextColorControl=document.getElementById("frame-text-color-control"),frameTextColorPicker=document.getElementById("frame-text-color-picker"),bottomFrameTextColorControl=document.getElementById("bottom-frame-text-color-control"),bottomFrameTextColorPicker=document.getElementById("bottom-frame-text-color-picker"),cropModal=document.getElementById("crop-modal"),cropModalTitle=document.getElementById("crop-modal-title"),imageToCrop=document.getElementById("image-to-crop"),confirmCropBtn=document.getElementById("confirm-crop-btn"),cancelCropBtn=document.getElementById("cancel-crop-btn");let font=null,cropper=null,currentCropTarget=null,cachedShortenedUrl=null,uploadedLogo=null,uploadedBackground=null,cachedQrGeometry={paths:null,moduleCount:0},isLogoActive=!1,isPlaceholderLogoActive=!1,options={cellSize:10,padding:10,dotScale:1,dotCornerRadius:2.5,dotInternalCornerRadius:0,finderStyle:{outer:{},inner:{},hole:{}},dotColor:"#000000",eyeColor:"#000000",baseLogoSizePercentage:.3,logoSizePercentage:.3,logoSafeZoneModules:1,gradientEnabled:!1,gradientColor1:"#000000",gradientColor2:"#8900d5",gradientType:"linear",gradientRotation:90,frameType:"none",frameText:"Отсканируй меня",frameBgColor:"#FFFFFF",frameTextColor:"#FFFFFF",bottomFrameTextColor:"#000000",framePadding:15,frameTextHeight:50,frameCornerRadius:12,adjustedFrameTextSize:null,backgroundCornerRadius:8};async function shortenUrl(e){let t=`https://clck.ru/--?url=${encodeURIComponent(e)}`;try{let o=await fetch(t);if(!o.ok)throw Error("Сервис clck.ru не отвечает.");return await o.text()}catch(n){return console.error("Ошибка при сокращении ссылки:",n),alert("Не удалось сократить ссылку."),e}}async function generateNewQRCode(){let e=qrTextInput.value.trim(),t=e,o=/^(https?:\/\/)/i;if(shortenUrlCheckbox.checked&&o.test(t)){if(cachedShortenedUrl&&cachedShortenedUrl.original===t)e=cachedShortenedUrl.short,shortenUrlLabel.textContent=`${originalShortenLabelText}: ${e}`;else{qrTextInput.disabled=!0,shortenUrlCheckbox.disabled=!0;try{let n=await shortenUrl(t);n!==t?(e=n,cachedShortenedUrl={original:t,short:e},shortenUrlLabel.textContent=`${originalShortenLabelText}: ${e}`):(shortenUrlCheckbox.checked=!1,shortenUrlLabel.textContent=originalShortenLabelText,cachedShortenedUrl=null)}finally{qrTextInput.disabled=!1,shortenUrlCheckbox.disabled=!1}}}else cachedShortenedUrl=null,shortenUrlLabel.textContent=originalShortenLabelText;let r=e;if(o.test(r))try{r=new URL(r).href}catch(a){}else try{r=unescape(encodeURIComponent(r))}catch(i){}if(!r){previewEl.innerHTML="",downloadBtn.disabled=!0,downloadBtnPng.disabled=!0,copyCodeBtn.disabled=!0,cachedShortenedUrl=null,cachedQrGeometry={paths:null,moduleCount:0};return}updateOptionsFromUI();let l=qrcode(0,isLogoActive?"H":"M");l.addData(r),l.make();let d=l.getModuleCount(),g=options.cellSize,s=[],{totalAreaToClearSize:c}=calculateLogoSizes(d,isLogoActive);for(let p=0;p<d;p++)for(let u=0;u<d;u++)if(l.isDark(p,u)&&!isPartOFFinderPattern(p,u,d)&&!isInsideLogoArea(p,u,d,c,isLogoActive)){let m=u*g+options.padding,f=p*g+options.padding;s.push(rectToPolygon(m,f,g,g,100)),u+1<d&&l.isDark(p,u+1)&&!isPartOFFinderPattern(p,u+1,d)&&!isInsideLogoArea(p,u+1,d,c,isLogoActive)&&s.push(rectToPolygon(m+g/2,f,g,g,100)),p+1<d&&l.isDark(p+1,u)&&!isPartOFFinderPattern(p+1,u,d)&&!isInsideLogoArea(p+1,u,d,c,isLogoActive)&&s.push(rectToPolygon(m,f+g/2,g,g,100))}let h=new ClipperLib.Clipper;h.AddPaths(s,ClipperLib.PolyType.ptSubject,!0);let y=new ClipperLib.Paths;h.Execute(ClipperLib.ClipType.ctUnion,y,ClipperLib.PolyFillType.pftNonZero,ClipperLib.PolyFillType.pftNonZero),cachedQrGeometry={paths:y,moduleCount:d},updateQrStyles()}function updateQrStyles(){if(!cachedQrGeometry.paths)return;updateOptionsFromUI(),previewEl.style.backgroundImage="none",previewEl.style.backgroundColor="transparent";let e=options.cellSize*(options.dotScale-1)/2*100,t=cachedQrGeometry.paths;if(Math.abs(e)>1){let o=new ClipperLib.ClipperOffset,n=new ClipperLib.Paths;o.AddPaths(cachedQrGeometry.paths,ClipperLib.JoinType.jtMiter,ClipperLib.EndType.etClosedPolygon),o.Execute(n,e),t=n}let r=clipperPathsToRoundedSvgPath(t,options.dotCornerRadius,options.dotInternalCornerRadius,100);previewEl.innerHTML=buildFinalSvg(cachedQrGeometry.moduleCount,r,!1),adjustFrameTextSize();let a=previewEl.querySelector("svg"),i=parseInt(bgOpacitySlider.value,10),l=bgGradientCheckbox.checked||bgImageCheckbox.checked&&uploadedBackground||""!==bgSolidColorPicker.value&&i>0;a&&a.classList.toggle("has-shadow","none"!==options.frameType||l),downloadBtn.disabled=!1,downloadBtnPng.disabled=!1,copyCodeBtn.disabled=!1}function handleLogoUpload(e){let t=e.target.files[0];if(!t)return;if(t.size>6291456){alert("Файл слишком большой (макс. 6 МБ)."),logoUploadInput.value="";return}currentCropTarget="logo";let o=new FileReader;o.onload=e=>{imageToCrop.src=e.target.result,cropModalTitle.textContent="Настройте ваш логотип",cropModal.style.display="flex",cropper=new Cropper(imageToCrop,{aspectRatio:1,viewMode:1,dragMode:"move",background:!1,autoCropArea:.9})},o.readAsDataURL(t)}function handleBackgroundUpload(e){let t=e.target.files[0];if(!t)return;if(t.size>6291456){alert("Файл слишком большой (макс. 6 МБ)."),backgroundUploadInput.value="";return}currentCropTarget="background";let o=new FileReader;o.onload=e=>{imageToCrop.src=e.target.result,cropModalTitle.textContent="Настройте ваш фон",cropModal.style.display="flex",cropper=new Cropper(imageToCrop,{aspectRatio:1,viewMode:1,dragMode:"move",background:!1,autoCropArea:1})},o.readAsDataURL(t)}function parseColorForSvg(e){if(!e||"transparent"===e)return{fill:"none",opacity:1};if(e.startsWith("#")&&9===e.length){let t=e.slice(7,9),o=parseInt(t,16)/255,n=e.slice(0,7);return 0===o?{fill:"none",opacity:0}:{fill:n,opacity:o.toFixed(2)}}if(e.startsWith("rgba")){let r=parseFloat(e.split(",")[3]);if(0===r)return{fill:"none",opacity:0}}return{fill:e,opacity:1}}function toggleColorInputsState(e){dotColorControl.classList.toggle("disabled-control",e),eyeColorControl.classList.toggle("disabled-control",e)}function toggleLogoSlidersState(e){logoRoundingControl.classList.toggle("disabled-control",e),logoSizeControl.classList.toggle("disabled-control",e)}function updateLogoButtonText(){logoUploadLabel.textContent=uploadedLogo?"Заменить логотип":"Загрузить логотип"}function generateTextAsPath(e,t,o,n,r){if(!font)return"";let a=font.stringToGlyphs(e),i=0;a.forEach(e=>i+=e.advanceWidth);let l=n/font.unitsPerEm,d=i*l,g=font.getPath(e,t-d/2,o+.35*n,n),s=parseColorForSvg(r);return g&&"function"==typeof g.toPathData?`<path fill="${s.fill}" fill-opacity="${s.opacity}" d="${g.toPathData()}" />`:""}function adjustFrameTextSize(){let e=document.getElementById("frame-text-element");if(!e||!cachedQrGeometry.moduleCount){options.adjustedFrameTextSize=null;return}let t=cachedQrGeometry.moduleCount*options.cellSize+2*options.padding,o=t+2*options.framePadding,n=o-50,r=.5*options.frameTextHeight,a=r;e.setAttribute("font-size",a);let i=e.getComputedTextLength();i>n&&(a*=n/i),(a=Math.floor(a))<8&&(a=8),e.setAttribute("font-size",a),options.adjustedFrameTextSize=a}function updateOptionsFromUI(){options.logoSizePercentage=options.baseLogoSizePercentage*(parseInt(logoSizeSlider.value,10)/100),logoSizeValueSpan.textContent=logoSizeSlider.value,options.dotScale=parseFloat(dotScaleSlider.value)/100,dotScaleValueSpan.textContent=dotScaleSlider.value,options.dotCornerRadius=parseInt(roundingSlider.value,10)/100*(options.cellSize/2),roundingValueSpan.textContent=roundingSlider.value;let e=parseInt(eyeRoundingSlider.value,10);if(eyeRoundingValueSpan.textContent=e,e<=50){let t=e/50;options.finderStyle={method:"arc",outer:{radius:3.5*options.cellSize*t},inner:{radius:1.5*options.cellSize*t},hole:{radius:2.5*options.cellSize*t}}}else{let o=.552284749831+(e-50)/50*.44771525016900005;options.finderStyle={method:"bezier",outer:{size:7*options.cellSize,radius:3.5*options.cellSize,factor:o},inner:{size:3*options.cellSize,radius:1.5*options.cellSize,factor:o},hole:{size:5*options.cellSize,radius:2.5*options.cellSize,factor:o}}}options.dotInternalCornerRadius=parseInt(internalRoundingSlider.value,10)/100*(options.cellSize/2),internalRoundingValueSpan.textContent=internalRoundingSlider.value,options.dotColor=dotColorPicker.value,options.eyeColor=eyeColorPicker.value,options.gradientEnabled=gradientDetails.open,options.gradientColor1=gradientColorPicker1.value,options.gradientColor2=gradientColorPicker2.value,options.gradientRotation=parseInt(gradientRotationSlider.value,10),gradientRotationValue.textContent=options.gradientRotation,toggleColorInputsState(options.gradientEnabled),options.frameText=frameTextInput.value,options.frameBgColor=frameBgColorPicker.value,options.frameTextColor=frameTextColorPicker.value,options.bottomFrameTextColor=bottomFrameTextColorPicker.value;let n=["full","full-top","text-panel"].includes(options.frameType),r="bottom-text"===options.frameType;frameTextControl.style.display=n||r?"block":"none",frameTextColorControl.style.display=n?"block":"none",bottomFrameTextColorControl.style.display=r?"block":"none",n||r||(options.adjustedFrameTextSize=null),frameBgColorControl.style.display="background"===options.frameType?"block":"none",bgGradientRotationValue.textContent=bgGradientRotationSlider.value,bgOpacityValue.textContent=bgOpacitySlider.value}function generateGradientDef(){if(!options.gradientEnabled)return"";let e=cachedQrGeometry.moduleCount*options.cellSize+2*options.padding,t=e,o=e;["full","full-top","text-panel","bottom-text"].includes(options.frameType)?(t+=2*options.framePadding,o+=2*options.framePadding+options.frameTextHeight):["simple","background"].includes(options.frameType)&&(t+=2*options.framePadding,o+=2*options.framePadding);let n=(options.gradientRotation-90)*(Math.PI/180),r=t/2,a=o/2,i=Math.sqrt(r**2+a**2),[l,d,g,s]=[r-Math.cos(n)*i,a-Math.sin(n)*i,r+Math.cos(n)*i,a+Math.sin(n)*i];return`<defs><linearGradient id="qr-gradient" gradientUnits="userSpaceOnUse" x1="${l}" y1="${d}" x2="${g}" y2="${s}"><stop offset="0%" stop-color="${options.gradientColor1}"/><stop offset="100%" stop-color="${options.gradientColor2}"/></linearGradient></defs>`}function generateBackgroundGradientDef(){if(!bgGradientCheckbox.checked)return"";let e=(parseInt(bgGradientRotationSlider.value,10)-90)*(Math.PI/180),t=parseColorForSvg(bgGradientColor1.value),o=parseColorForSvg(bgGradientColor2.value);return`<defs><linearGradient id="bg-gradient" gradientUnits="objectBoundingBox" x1="${.5-.5*Math.cos(e)}" y1="${.5-.5*Math.sin(e)}" x2="${.5+.5*Math.cos(e)}" y2="${.5+.5*Math.sin(e)}"><stop offset="0%" stop-color="${t.fill}" stop-opacity="${t.opacity}"/><stop offset="100%" stop-color="${o.fill}" stop-opacity="${o.opacity}"/></linearGradient></defs>`}function getFrameBackgroundLayer(e,t,o,n,r){if(bgImageCheckbox.checked&&uploadedBackground){let a="bg-clip-"+Math.random().toString(36).substr(2,9);return`<defs><clipPath id="${a}"><rect x="${e}" y="${t}" width="${o}" height="${n}" rx="${r}"/></clipPath></defs>
                <image href="${uploadedBackground.data}" xlink:href="${uploadedBackground.data}" x="${e}" y="${t}" width="${o}" height="${n}" preserveAspectRatio="xMidYMid slice" clip-path="url(#${a})" />`}if(bgGradientCheckbox.checked)return`<rect x="${e}" y="${t}" width="${o}" height="${n}" rx="${r}" fill="url(#bg-gradient)"/>`;{let i=bgSolidColorPicker.value||"#ffffff",l=parseInt(bgOpacitySlider.value,10)/100;return 0===l?"":`<rect x="${e}" y="${t}" width="${o}" height="${n}" rx="${r}" fill="${i}" fill-opacity="${l}"/>`}}function generateFrameSvg(e,t=!1,o=!1){if("none"===options.frameType)return"";let n=e*options.cellSize+2*options.padding,r=options.gradientEnabled?"url(#qr-gradient)":options.dotColor,a=t&&options.adjustedFrameTextSize||.45*options.frameTextHeight,i="'Rubik-Custom', sans-serif",l=n+2*options.framePadding,d=n+2*options.framePadding;["full","full-top","text-panel","bottom-text"].includes(options.frameType)&&(d+=options.frameTextHeight);let g="",s="bottom-text"===options.frameType?options.bottomFrameTextColor:options.frameTextColor,c=`<rect x="${options.framePadding+1}" y="${options.framePadding+1}" width="${n-2}" height="${n-2}" rx="${options.frameCornerRadius/2}" fill="white"/>`,p=`<rect x="${options.framePadding+1}" y="${options.framePadding+options.frameTextHeight+1}" width="${n-2}" height="${n-2}" rx="${options.frameCornerRadius/2}" fill="white"/>`,u=`<rect x="0" y="0" width="${l}" height="${d}" rx="${options.frameCornerRadius}" fill="white"/>`;if("full"===options.frameType){let m=options.framePadding+n+options.frameTextHeight/2+7,f=o&&font?generateTextAsPath(options.frameText,l/2,m,a,options.frameTextColor):`<text id="frame-text-element" x="${l/2}" y="${m}" dominant-baseline="middle" font-family="${i}" font-size="${a}" font-weight="bold" text-anchor="middle" fill="${s}">${options.frameText}</text>`,h=getFrameBackgroundLayer(options.framePadding,options.framePadding,n,n,options.frameCornerRadius/2);g=`<rect x="0" y="0" width="${l}" height="${d}" rx="${options.frameCornerRadius}" fill="${r}"/>${c}${h}${f}`}else if("full-top"===options.frameType){let y=(options.framePadding+options.frameTextHeight)/2+2,b=o&&font?generateTextAsPath(options.frameText,l/2,y,a,options.frameTextColor):`<text id="frame-text-element" x="${l/2}" y="${y}" dominant-baseline="middle" font-family="${i}" font-size="${a}" font-weight="bold" text-anchor="middle" fill="${s}">${options.frameText}</text>`,C=getFrameBackgroundLayer(options.framePadding,options.framePadding+options.frameTextHeight,n,n,options.frameCornerRadius/2);g=`<rect x="0" y="0" width="${l}" height="${d}" rx="${options.frameCornerRadius}" fill="${r}"/>${p}${C}${b}`}else if("text-panel"===options.frameType){let x=n+2*options.framePadding,S=`M 0,${x} H ${l} V ${d-options.frameCornerRadius} A ${options.frameCornerRadius},${options.frameCornerRadius} 0 0 1 ${l-options.frameCornerRadius},${d} H ${options.frameCornerRadius} A ${options.frameCornerRadius},${options.frameCornerRadius} 0 0 1 0,${d-options.frameCornerRadius} Z`,$=x+options.frameTextHeight/2,v=o&&font?generateTextAsPath(options.frameText,l/2,$,a,options.frameTextColor):`<text id="frame-text-element" x="${l/2}" y="${$}" dominant-baseline="middle" font-family="${i}" font-size="${a}" font-weight="bold" text-anchor="middle" fill="${s}">${options.frameText}</text>`,k=getFrameBackgroundLayer(0,0,l,d,options.frameCornerRadius);g=`${u}${k}<path d="${S}" fill="${r}"/>${v}`}else if("bottom-text"===options.frameType){let L=d-options.frameTextHeight/2-8,E=o&&font?generateTextAsPath(options.frameText,l/2,L,a,s):`<text id="frame-text-element" x="${l/2}" y="${L}" dominant-baseline="middle" font-family="${i}" font-size="${a}" font-weight="bold" text-anchor="middle" fill="${s}">${options.frameText}</text>`,T=getFrameBackgroundLayer(0,0,l,d,options.frameCornerRadius);g=`${u}${T}${E}`}else if("simple"===options.frameType){let I=getFrameBackgroundLayer(options.framePadding,options.framePadding,n,n,options.frameCornerRadius/2);g=`<rect x="0" y="0" width="${l}" height="${d}" rx="${options.frameCornerRadius}" fill="${r}"/>${c}${I}`}else if("background"===options.frameType){let _=getFrameBackgroundLayer(0,0,l,d,options.frameCornerRadius);g=`${u}${_}`}return`<g id="frame">${g}</g>`}function buildFinalSvg(e,t,o=!1,n=!1){let r=e*options.cellSize+2*options.padding,a=r,i=r;"none"!==options.frameType&&(a+=2*options.framePadding,i+=2*options.framePadding,["full","full-top","text-panel","bottom-text"].includes(options.frameType)&&(i+=options.frameTextHeight));let{logoPlaceholderSize:l}=calculateLogoSizes(e,isLogoActive),d="";if("none"===options.frameType){let g=options.backgroundCornerRadius;d=getFrameBackgroundLayer(0,0,r,r,g)}let s=parseColorForSvg(options.dotColor),c=options.gradientEnabled?'fill="url(#qr-gradient)"':`fill="${s.fill}" fill-opacity="${s.opacity}"`,p=`${d}<g id="data-dots"><path d="${t}" ${c}/></g>${generateFinderPatternsSvg(e)}${generateLogoSvg(e,l,isLogoActive,o)||""}`,u=generateBackgroundGradientDef(),m=generateGradientDef();if("none"===options.frameType)return`<svg viewBox="0 0 ${r} ${r}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">${u}${m}<g id="qr-code-content">${p}</g></svg>`;{let f=options.framePadding;"full-top"===options.frameType&&(f+=options.frameTextHeight);let h=`transform="translate(${options.framePadding}, ${f})"`;return`<svg viewBox="0 0 ${a} ${i}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">${u}${m}${generateFrameSvg(e,o,n)}<g id="qr-code-content" ${h}>${p}</g></svg>`}}function downloadSVG(){cachedQrGeometry.paths&&downloadFile(new Blob([buildFinalSvg(cachedQrGeometry.moduleCount,clipperPathsToRoundedSvgPath(cachedQrGeometry.paths,options.dotCornerRadius,options.dotInternalCornerRadius,100),!0,!0)],{type:"image/svg+xml"}),"qrcode.svg")}async function downloadPNG(){if(!cachedQrGeometry.paths)return;let e=options.cellSize*(options.dotScale-1)/2*100,t=cachedQrGeometry.paths;if(Math.abs(e)>1){let o=new ClipperLib.ClipperOffset,n=new ClipperLib.Paths;o.AddPaths(cachedQrGeometry.paths,ClipperLib.JoinType.jtMiter,ClipperLib.EndType.etClosedPolygon),o.Execute(n,e),t=n}let r=clipperPathsToRoundedSvgPath(t,options.dotCornerRadius,options.dotInternalCornerRadius,100),a=buildFinalSvg(cachedQrGeometry.moduleCount,r,!0,!0),{moduleCount:i}=cachedQrGeometry,l=i*options.cellSize+2*options.padding,d=l,g=l;"none"!==options.frameType&&(d+=2*options.framePadding,g+=2*options.framePadding,["full","full-top","text-panel","bottom-text"].includes(options.frameType)&&(g+=options.frameTextHeight));let s=d/g,c=1024/s,p=document.createElement("canvas");p.width=1024,p.height=c;let u=p.getContext("2d");try{var m;let f=await (m=URL.createObjectURL(new Blob([a],{type:"image/svg+xml;charset=utf-8"})),new Promise((e,t)=>{let o=new Image;o.onload=()=>e(o),o.onerror=t,o.src=m}));u.drawImage(f,0,0,1024,c),downloadFile(p.toDataURL("image/png"),"qrcode.png")}catch(h){console.error("Could not load SVG image for PNG export",h)}}async function copySvgCode(){if(cachedQrGeometry.paths)try{await navigator.clipboard.writeText(buildFinalSvgForDownload(!0,!0)),copyCodeBtn.textContent="Скопировано!",setTimeout(()=>{copyCodeBtn.textContent="Скопировать код SVG"},2e3)}catch(e){alert("Не удалось скопировать код.")}}function buildFinalSvgForDownload(e,t){let o=options.cellSize*(options.dotScale-1)/2*100,n=cachedQrGeometry.paths;if(Math.abs(o)>1){let r=new ClipperLib.ClipperOffset,a=new ClipperLib.Paths;r.AddPaths(cachedQrGeometry.paths,ClipperLib.JoinType.jtMiter,ClipperLib.EndType.etClosedPolygon),r.Execute(a,o),n=a}let i=clipperPathsToRoundedSvgPath(n,options.dotCornerRadius,options.dotInternalCornerRadius,100);return buildFinalSvg(cachedQrGeometry.moduleCount,i,e,t)}function handleLogoRemove(){isLogoActive=!1,isPlaceholderLogoActive=!1,uploadedLogo=null,logoUploadInput.value="",removeLogoWrapper.style.display="none",updateLogoButtonText(),generateNewQRCode(),document.querySelectorAll(".preset-logo-wrapper").forEach(e=>e.classList.remove("selected")),toggleLogoSlidersState(!0)}function generateLogoSvg(e,t,o,n=!1){if(!o||t<=0)return null;let r=Math.floor(e/2)-Math.floor(t/2),a=r*options.cellSize+options.padding,i=r*options.cellSize+options.padding,l=t*options.cellSize,d=e*options.logoSizePercentage,g=d-2*options.logoSafeZoneModules,s=g*options.cellSize,c=a+(l-s)/2,p=i+(l-s)/2,u=parseInt(logoRoundingSlider.value,10);logoRoundingValueSpan.textContent=u;let m={};if(m=u<=50?{method:"arc",radius:s/2*(u/50)}:{method:"bezier",size:s,radius:s/2,factor:.552284749831+(u-50)/50*.44771525016900005},isPlaceholderLogoActive){let f=options.gradientEnabled?"url(#qr-gradient)":options.dotColor;return`<g id="logo-placeholder">${"bezier"===m.method?`<path d="${createSuperellipsePath(c,p,m)}" fill="${f}"/>`:`<rect x="${c}" y="${p}" width="${s}" height="${s}" rx="${m.radius}" fill="${f}"/>`}</g>`}if(uploadedLogo){let h=generateLogoClipPath(c,p,s,m);if("svg"!==uploadedLogo.type||!n)return`${h}<g id="logo-image" clip-path="url(#logo-clip-path)"><image href="${n?uploadedLogo.fullData:uploadedLogo.previewData}" xlink:href="${n?uploadedLogo.fullData:uploadedLogo.previewData}" x="${c}" y="${p}" width="${s}" height="${s}"/></g>`;{let y=new DOMParser().parseFromString(uploadedLogo.fullData,"image/svg+xml"),b=y.documentElement;return["x","y","width","height","preserveAspectRatio"].forEach(e=>b.setAttribute(e,[c,p,s,s,"xMidYMid meet"][["x","y","width","height","preserveAspectRatio"].indexOf(e)])),`${h}<g id="logo-image" clip-path="url(#logo-clip-path)">${b.outerHTML}</g>`}}return null}async function loadInitialLogo(e){isLogoActive=!0;try{let t=e.startsWith("data:image/svg+xml"),o,n;if(t)n=e,o=atob(e.split(",")[1]);else{let r=await fetch(e);if(!r.ok)throw Error("Network response was not ok");n=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(o=await r.text())))}`}let a=new Image;a.onload=()=>{uploadedLogo={type:"svg",previewData:n,fullData:o},logoPreview.src=n,removeLogoWrapper.style.display="flex",updateLogoButtonText(),generateNewQRCode(),toggleLogoSlidersState(!1)},a.src=n}catch(i){console.error("Failed to fetch initial logo:",i),isLogoActive=!1,removeLogoWrapper.style.display="none",generateNewQRCode(),toggleLogoSlidersState(!0)}}function initializePresetLogos(){let e=document.querySelectorAll(".preset-logo-wrapper:not(.preset-background-item)");e.forEach(t=>{"remove-logo-preset"!==t.id&&"upload-logo-preset"!==t.id&&t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),isPlaceholderLogoActive="placeholder-logo-preset"===t.id,t.dataset.logoUrl&&loadInitialLogo(t.dataset.logoUrl)})}),document.getElementById("remove-logo-preset")?.addEventListener("click",handleLogoRemove),document.getElementById("upload-logo-preset")?.addEventListener("click",()=>logoUploadInput.click())}function initializePresetFrames(){document.querySelectorAll(".preset-frame-wrapper").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".preset-frame-wrapper").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),options.frameType=e.dataset.frameType,generateNewQRCode()})})}function clipperPathsToRoundedSvgPath(e,t,o,n){let r="";for(let a of e){let i="";for(let l=0;l<a.length;l++){let d=a[(l-1+a.length)%a.length],g=a[l],s=a[(l+1)%a.length],c={X:d.X-g.X,Y:d.Y-g.Y},p={X:s.X-g.X,Y:s.Y-g.Y},u=c.X*p.Y-c.Y*p.X,m=Math.hypot(c.X,c.Y),f=Math.hypot(p.X,p.Y),h=u<0?t:o;if(h>.01){let y=Math.min(h*n,m/2,f/2),b={X:c.X/m,Y:c.Y/m},C={X:p.X/f,Y:p.Y/f},x={X:g.X+b.X*y,Y:g.Y+b.Y*y},S={X:g.X+C.X*y,Y:g.Y+C.Y*y};i+=(0===l?"M":"L")+`${x.X/n} ${x.Y/n} A ${h} ${h} 0 0 ${u<0?1:0} ${S.X/n} ${S.Y/n} `}else i+=(0===l?"M":"L")+`${g.X/n} ${g.Y/n} `}r+=i+"Z "}return r}function rectToPolygon(e,t,o,n,r){return[{X:e*r,Y:t*r},{X:(e+o)*r,Y:t*r},{X:(e+o)*r,Y:(t+n)*r},{X:e*r,Y:(t+n)*r}]}function calculateLogoSizes(e,t){if(!t)return{totalAreaToClearSize:0,logoPlaceholderSize:0};let o=Math.round(e*options.logoSizePercentage);return o%2==0&&o--,{totalAreaToClearSize:o,logoPlaceholderSize:o-2*options.logoSafeZoneModules}}function isPartOFFinderPattern(e,t,o){return e<7&&t<7||e<7&&t>=o-7||e>=o-7&&t<7}function isInsideLogoArea(e,t,o,n,r){if(!r||n<=0)return!1;let a=Math.floor(o/2),i=Math.floor(n/2),l=a-i,d=a+i;return e>=l&&e<=d&&t>=l&&t<=d}function createSuperellipsePath(e,t,o){let{size:n,radius:r,factor:a}=o;if(0===r)return`M ${e},${t} H ${e+n} V ${t+n} H ${e} Z`;let i=r*a;return`M ${e+r},${t} L ${e+n-r},${t} C ${e+n-r+i},${t} ${e+n},${t+r-i} ${e+n},${t+r} L ${e+n},${t+n-r} C ${e+n},${t+n-r+i} ${e+n-r+i},${t+n} ${e+n-r},${t+n} L ${e+r},${t+n} C ${e+r-i},${t+n} ${e},${t+n-r+i} ${e},${t+n-r} L ${e},${t+r} C ${e},${t+r-i} ${e+r-i},${t} ${e+r},${t} Z`}function generateFinderPatternsSvg(e){let t=options.padding,o=options.cellSize,n=1+(options.dotScale-1)*.6,r=5*o+2*(o*n),a=(7*o-r)/2,i=3*o,l=(7*o-i)/2;options.gradientEnabled||options.eyeColor;let d="";if(options.gradientEnabled)d='fill="url(#qr-gradient)"';else{let g=parseColorForSvg(options.eyeColor);d=`fill="${g.fill}" fill-opacity="${g.opacity}"`}return`<g id="finder-patterns">${[[t,t],[t+(e-7)*o,t],[t,t+(e-7)*o]].map(([e,t],n)=>{if("bezier"===options.finderStyle.method){let g=createSuperellipsePath(e+a,t+a,{...options.finderStyle.outer,size:r,radius:options.finderStyle.outer.radius*(r/(7*o))}),s=createSuperellipsePath(e+o,t+o,options.finderStyle.hole),c=createSuperellipsePath(e+l,t+l,{...options.finderStyle.inner,size:i});return`<g id="finder-pattern-${n+1}"><path d="${g} ${s}" ${d} fill-rule="evenodd"/><path d="${c}" ${d}/></g>`}{let p=options.finderStyle.outer.radius*(r/(7*o)),u=options.finderStyle.inner.radius,m=options.finderStyle.hole.radius,f=`M ${e+a+p},${t+a} h ${r-2*p} a ${p},${p} 0 0 1 ${p},${p} v ${r-2*p} a ${p},${p} 0 0 1 -${p},${p} h -${r-2*p} a ${p},${p} 0 0 1 -${p},-${p} v -${r-2*p} a ${p},${p} 0 0 1 ${p},-${p}z`,h=`M ${e+o+m},${t+o} h ${5*o-2*m} a ${m},${m} 0 0 1 ${m},${m} v ${5*o-2*m} a ${m},${m} 0 0 1 -${m},${m} h -${5*o-2*m} a ${m},${m} 0 0 1 -${m},-${m} v -${5*o-2*m} a ${m},${m} 0 0 1 ${m},-${m}z`;return`<g id="finder-pattern-${n+1}"><path d="${f} ${h}" ${d} fill-rule="evenodd"/><rect x="${e+l}" y="${t+l}" width="${i}" height="${i}" rx="${u}" ${d}/></g>`}}).join("")}</g>`}function generateLogoClipPath(e,t,o,n){let r;return`<defs><clipPath id="logo-clip-path">${r="bezier"===n.method?`<path d="${createSuperellipsePath(e,t,n)}"/>`:`<rect x="${e}" y="${t}" width="${o}" height="${o}" rx="${n.radius}"/>`}</clipPath></defs>`}function downloadFile(e,t){let o=document.createElement("a");o.href="string"==typeof e&&e.startsWith("data:")?e:URL.createObjectURL(e),o.download=t,document.body.appendChild(o).click(),document.body.removeChild(o),"string"==typeof e&&e.startsWith("data:")||URL.revokeObjectURL(o.href)}function toggleSolidColorInputState(){let e=bgGradientCheckbox.checked,t=bgImageCheckbox.checked;e||t?(bgSolidColorControl.classList.add("disabled-control"),bgOpacityControl.classList.add("disabled-control")):(bgSolidColorControl.classList.remove("disabled-control"),bgOpacityControl.classList.remove("disabled-control"))}function initializePresetBackgrounds(){let e=document.querySelectorAll(".preset-background-item");document.getElementById("upload-background-preset")?.addEventListener("click",()=>backgroundUploadInput.click()),e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),bgImageCheckbox.checked=!0,bgImageDetails.open=!0,bgGradientCheckbox.checked=!1,bgGradientDetails.open=!1,toggleSolidColorInputState();let o=t.dataset.bgSrc;if(o){let n=new Image;n.crossOrigin="Anonymous",n.onload=function(){let e=document.createElement("canvas");e.width=n.width,e.height=n.height;let t=e.getContext("2d");t.drawImage(n,0,0),uploadedBackground={type:"image",data:e.toDataURL("image/png")},updateQrStyles()},n.src=o}})})}opentype.load("/qr/fonts/Rubik-Medium.woff",function(e,t){e?(console.error("Шрифт не может быть загружен: "+e),alert("Не удалось загрузить шрифт для экспорта.")):(font=t,console.log("Шрифт Rubik Medium успешно загружен для экспорта."))}),qrTextInput.addEventListener("input",()=>{shortenUrlCheckbox.checked&&(shortenUrlCheckbox.checked=!1,shortenUrlLabel.textContent=originalShortenLabelText),cachedShortenedUrl=null,generateNewQRCode()}),shortenUrlCheckbox.addEventListener("change",generateNewQRCode),downloadBtn.addEventListener("click",downloadSVG),downloadBtnPng.addEventListener("click",downloadPNG),copyCodeBtn.addEventListener("click",copySvgCode),dotScaleSlider.addEventListener("input",updateQrStyles),roundingSlider.addEventListener("input",updateQrStyles),eyeRoundingSlider.addEventListener("input",updateQrStyles),logoRoundingSlider.addEventListener("input",updateQrStyles),logoSizeSlider.addEventListener("input",generateNewQRCode),internalRoundingSlider.addEventListener("input",updateQrStyles),logoUploadInput.addEventListener("change",handleLogoUpload),removeLogoWrapper.addEventListener("click",handleLogoRemove),dotColorPicker.addEventListener("input",updateQrStyles),eyeColorPicker.addEventListener("input",updateQrStyles),gradientColorPicker1.addEventListener("input",updateQrStyles),gradientColorPicker2.addEventListener("input",updateQrStyles),gradientRotationSlider.addEventListener("input",updateQrStyles),gradientSummary.addEventListener("click",e=>{e.target.closest(".switch")||(e.preventDefault(),gradientToggleCheckbox.checked=!gradientToggleCheckbox.checked,gradientToggleCheckbox.dispatchEvent(new Event("change")))}),gradientToggleCheckbox.addEventListener("change",()=>{gradientDetails.open=gradientToggleCheckbox.checked}),gradientDetails.addEventListener("toggle",()=>{gradientToggleCheckbox.checked!==gradientDetails.open&&(gradientToggleCheckbox.checked=gradientDetails.open),updateQrStyles()}),frameTextInput.addEventListener("input",()=>{frameTextInput.value.length>40&&(frameTextInput.value=frameTextInput.value.slice(0,40)),updateQrStyles()}),frameBgColorPicker.addEventListener("input",updateQrStyles),frameTextColorPicker.addEventListener("input",updateQrStyles),bottomFrameTextColorPicker.addEventListener("input",updateQrStyles),bgSolidColorPicker.addEventListener("input",updateQrStyles),bgOpacitySlider.addEventListener("input",()=>{bgOpacityValue.textContent=bgOpacitySlider.value,updateQrStyles()}),bgGradientSummary.addEventListener("click",e=>{e.target.closest(".switch")||(e.preventDefault(),bgGradientCheckbox.checked=!bgGradientCheckbox.checked,bgGradientCheckbox.dispatchEvent(new Event("change")))}),bgGradientCheckbox.addEventListener("change",()=>{bgGradientDetails.open=bgGradientCheckbox.checked,bgGradientCheckbox.checked&&(bgImageCheckbox.checked=!1,bgImageDetails.open=!1),toggleSolidColorInputState(),updateQrStyles()}),bgGradientDetails.addEventListener("toggle",()=>{bgGradientCheckbox.checked!==bgGradientDetails.open&&(bgGradientCheckbox.checked=bgGradientDetails.open,bgGradientCheckbox.dispatchEvent(new Event("change")))}),bgImageSummary.addEventListener("click",e=>{e.target.closest(".switch")||(e.preventDefault(),bgImageCheckbox.checked=!bgImageCheckbox.checked,bgImageCheckbox.dispatchEvent(new Event("change")))}),bgImageCheckbox.addEventListener("change",()=>{bgImageDetails.open=bgImageCheckbox.checked,bgImageCheckbox.checked&&(bgGradientCheckbox.checked=!1,bgGradientDetails.open=!1),toggleSolidColorInputState(),updateQrStyles()}),bgImageDetails.addEventListener("toggle",()=>{bgImageCheckbox.checked!==bgImageDetails.open&&(bgImageCheckbox.checked=bgImageDetails.open,bgImageCheckbox.dispatchEvent(new Event("change")))}),bgGradientColor1.addEventListener("input",updateQrStyles),bgGradientColor2.addEventListener("input",updateQrStyles),bgGradientRotationSlider.addEventListener("input",updateQrStyles),confirmCropBtn.addEventListener("click",()=>{if(!cropper)return;let e=cropper.getCroppedCanvas({width:512,height:512,imageSmoothingQuality:"high"}),t=e.toDataURL("image/png");"logo"===currentCropTarget?(isLogoActive=!0,isPlaceholderLogoActive=!1,document.querySelectorAll(".preset-logo-wrapper").forEach(e=>e.classList.remove("selected")),uploadedLogo={type:"raster",previewData:t,fullData:t},logoPreview.src=t,removeLogoWrapper.style.display="flex",updateLogoButtonText(),toggleLogoSlidersState(!1)):"background"===currentCropTarget&&(uploadedBackground={type:"image",data:t},document.querySelectorAll(".preset-background-item").forEach(e=>e.classList.remove("selected")),bgImageCheckbox.checked=!0,bgImageDetails.open=!0,bgGradientCheckbox.checked=!1,bgGradientDetails.open=!1,toggleSolidColorInputState()),generateNewQRCode(),cropModal.style.display="none",cropper.destroy(),cropper=null,logoUploadInput.value="",backgroundUploadInput.value=""}),cancelCropBtn.addEventListener("click",()=>{cropModal.style.display="none",cropper&&cropper.destroy(),cropper=null,logoUploadInput.value="",backgroundUploadInput.value=""}),backgroundUploadInput.addEventListener("change",handleBackgroundUpload),document.fonts.ready.then(()=>{console.log("Все CSS шрифты загружены."),generateNewQRCode()}),initializePresetLogos(),initializePresetFrames(),initializePresetBackgrounds(),gradientToggleCheckbox.checked=gradientDetails.open,toggleColorInputsState(gradientDetails.open),toggleLogoSlidersState(!isLogoActive),toggleSolidColorInputState(),frameTextControl.style.display="none",frameTextColorControl.style.display="none",frameBgColorControl.style.display="none";